version: '3.8'

services:
  imagesearch-java-stack:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: imagesearch-java-unified
    environment:
      - POSTGRES_PASSWORD=changeme123
      # Memory optimized settings (matching run-all-java-stack-optimized.sh)
      - ES_JAVA_OPTS=-Xms512m -Xmx1g
    deploy:
      resources:
        limits:
          memory: 3g  # Total container limit
        reservations:
          memory: 1.5g
    volumes:
      # Persist data outside container
      - app-data:/app/data
      - postgres-data:/var/lib/postgresql/16/main
      - elasticsearch-data:/var/lib/elasticsearch
    ports:
      - "3000:3000"   # React Frontend
      - "8080:8080"   # Java Backend API
      - "5001:5001"   # Java Search Service
      - "5432:5432"   # PostgreSQL (optional, for external access)
      - "9200:9200"   # Elasticsearch (optional, for external access)
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

volumes:
  app-data:
    driver: local
  postgres-data:
    driver: local  
  elasticsearch-data:
    driver: local

networks:
  default:
    name: imagesearch-network